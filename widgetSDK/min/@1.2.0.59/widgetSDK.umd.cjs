(function(f,d){typeof exports=="object"&&typeof module<"u"?module.exports=d():typeof define=="function"&&define.amd?define(d):(f=typeof globalThis<"u"?globalThis:f||self,f.WidgetSDK=d())})(this,function(){"use strict";class f{constructor(t,e){Object.assign(this,t),this._fullMeta=e}getColor(t){return this.widgetOptions.choiceOptions?.[t]?.fillColor}getTextColor(t){return this.widgetOptions.choiceOptions?.[t]?.textColor}getIsFormula(){return this.isFormula&&this.formula?.trim()}async getChoices(){const t=this.type.split(":");if(t[0]==="Ref"||t[0]==="RefList"){const e=await grist.docApi.fetchTable(t[1]),s=await this.getMeta(this.visibleCol);return e[s.colId]}else if(t[0]==="Choice"||t[0]==="ChoiceList")return this.widgetOptions?.choices;return null}async getURL(t){return this.type.split(":")[0]==="Attachments"?await this._fullMeta.getURL(t):null}async parse(t,e=null,s=null){const n=this.type.split(":");if(n[0]==="RefList"){if(t&&t.length>0&&(t[0]==="L"&&(t=t.splice(0,1)),t.length>0&&typeof t[0]=="number")){const a=e??await grist.docApi.fetchTable(n[1]),l=s??await this.getMeta(this.visibleCol);return t.map(o=>a?.id?.indexOf(o)).map(o=>a[l.colId][o])}}else if(n[0]==="Ref"){if(Array.isArray(t))if(t[2]>0)if(this.visibleCol>0){const a=e??await grist.docApi.fetchTable(t[1]),l=s??await this.getMeta(this.visibleCol),r=a?.id?.indexOf(t[2]);return await this.parse(a[l.colId][r])}else return t[2];else return;else if(typeof t=="object")if(t.rowId>0)if(this.visibleCol>0){const a=e??await grist.docApi.fetchTable(t.tableId),l=s??await this.getMeta(this.visibleCol),r=a?.id?.indexOf(t.rowId);return await this.parse(a[l.colId][r])}else return t.rowId;else return}else if(n[0]==="Date"){if(Array.isArray(t))return t[1]>0?new Date(t[1]*1e3):void 0}else if(n[0]==="DateTime"&&Array.isArray(t))return t[1]>0?new Date(t[1]*1e3):void 0;return t}async parseId(t,e=null,s=null){const n=this.type.split(":");if(n[0]==="RefList"){if(t&&t.length>0&&(t[0]==="L"&&(t=t.splice(0,1)),t.length>0&&typeof t[0]!="number")){const a=e??await grist.docApi.fetchTable(n[1]),l=s??await this.getMeta(this.visibleCol);return t.map(o=>a[l.colId]?.indexOf(o)).map(o=>a.id[o])}}else if(n[0]==="Ref"){if(Array.isArray(t))return t[2];if(typeof t=="object")return t.rowId;{const a=e??await grist.docApi.fetchTable(n[1]),l=s??await this.getMeta(this.visibleCol),r=a[l.colId].indexOf(t);return a.id[r]}}return t}async encode(t,e=null,s=null){if(t==null)return t;const n=this.type.split(":");if(n[0]==="RefList"){if(Array.isArray(t)&&t.length>0&&typeof t[0]!="number"){const a=e??await grist.docApi.fetchTable(n[1]),l=s??await this.getMeta(this.visibleCol);return t.map(o=>a[l.colId]?.indexOf(o)).map(o=>a.id[o])}}else if(n[0]==="Ref"&&typeof t[0]!="number"){const a=e??await grist.docApi.fetchTable(n[1]),l=s??await this.getMeta(this.visibleCol),r=a[l.colId].indexOf(t);return a.id[r]}return t}async getMeta(t){return this._fullMeta.then(e=>e.col.find(s=>s.id===t))}}class d{static async fetchMetas(){const t=await grist.docApi.fetchTable("_grist_Tables_column"),e=Object.keys(t),n=t.parentId.map((r,o)=>o).map(r=>{let o=Object.fromEntries(e.map(c=>[c,t[c][r]]));return o.widgetOptions=d.safeParse(o.widgetOptions),o}),a=await grist.docApi.fetchTable("_grist_Tables"),l=Object.fromEntries(a.tableId.map((r,o)=>[r,a.id[o]]));return{col:n,tab:l}}static getTableMeta(t,e){return t.col.filter(s=>s.parentId===t.tab[e])}constructor(){this._tableId=null,this._colIds=null,this._metaPromise=null,this._colPromise=null,this._col=null,this._accessLevel="",this.loaded=!1,grist.on("message",t=>{t.settings&&this._accessLevel!==t.settings.accessLevel&&(this._accessLevel=t.settings.accessLevel,this.fetchColumns()),t.tableId&&t.mappingsChange&&(this._tableId=t.tableId,this.fetchColumns())})}fetchColumns(){this._accessLevel==="full"&&(this._col=null,this._metaPromise=d.fetchMetas(),this._colPromise=new Promise(t=>{this._metaPromise.then(e=>t(d.getTableMeta(e,this._tableId)))}))}mapColumns(t,e){return t}async getTypes(){return this._colPromise.then(t=>Object.fromEntries(t.map(e=>[e.colId,e?.type])))}async getColType(t){return this._colPromise.then(e=>e.find(s=>s.colId===t)?.type)}async getOptions(){return this._colPromise.then(t=>Object.fromEntries(t.map(e=>[e.colId,e?.widgetOptions])))}async getColOption(t){return this._colPromise.then(e=>e.find(s=>s.colId===t)?.widgetOptions)}async IsFormula(){return this._colPromise.then(t=>Object.fromEntries(t.map(e=>[e.colId,e?.isFormula&&(e?.formula?.length??0)!==0])))}async IsColFormula(t){return this._colPromise.then(e=>{const s=e.find(n=>n.colId===t);return s?.isFormula&&(s?.formula?.length??0)!==0})}async getColor(t,e){return this.getColOption(t)?.choiceOptions?.[e]?.fillColor}async getURL(t){const e=await grist.docApi.getAccessToken({readOnly:!0});return Array.isArray(t)?t.map(s=>`${e.baseUrl}/attachments/${s}/download?auth=${e.token}`):`${e.baseUrl}/attachments/${t}/download?auth=${e.token}`}async getMeta(t=null){return t?this._metaPromise.then(e=>{const s=d.getTableMeta(e,t);return Object.fromEntries(s.map(n=>[n.colId,new f(n,this._metaPromise.then(a=>a))]))}):(this._col||(this._col=this._colPromise.then(e=>Object.fromEntries(e.map(s=>[s.colId,new f(s,this._metaPromise.then(n=>n))])))),this._col)}async getColMeta(t){return this._colPromise.then(e=>{const s=e.find(n=>n.colId===t);return s?new f(s,this._metaPromise.value):null})}isLoaded(){return this._colPromise?this._colPromise?.state!=="pending":!1}static safeParse(t){try{return JSON.parse(t)}catch{return null}}}class u{constructor(){console.log("WidgetSDK: 1.2.0.59");const t=new URLSearchParams(window.location.search);this.cultureFull=t.has("culture")?t.get("culture"):"en-US",this.culture=this.cultureFull.split("-")[0],this.currency=t.has("currency")?t.get("currency"):"USD",this.timeZone=t.has("timeZone")?t.get("timeZone"):"",this._gristloaded=!1,this._optloaded=!1,this._ismapped=!1,this.initDone=!1,this.urlSDK="https://varamil.github.io/grist-widget/widgetSDK",grist.on("message",async e=>{e.fromReady&&(this._gristloaded=e.fromReady)})}static async sleep(t){return new Promise(e=>setTimeout(e,t))}triggerEvent(t,e){this.events["on"+t]&&this.events["on"+t].apply(this,e)}is(t){return t!=null}async isLoaded(){return new Promise(async(t,e)=>{try{if(this.meta){for(;!this.meta.isLoaded();)await u.sleep(50);this.col=this.mapColumnNames(await this.meta.getMeta())}if(this.opt)for(;!this._optloaded;)await u.sleep(50);for(;!this._gristloaded;)await u.sleep(50);t(!0)}catch(s){e(s)}})}async isInit(){return this.initDone&&await this.isLoaded()?new Promise(t=>t(!0)):new Promise(async(t,e)=>{try{for(await this.isLoaded();!this.initDone;)await u.sleep(50);t(!0)}catch(s){e(s)}})}async isMapped(){return!this.meta||this._ismapped?new Promise(t=>t(!0)):new Promise(async(t,e)=>{try{for(;!this._ismapped;)await u.sleep(50);t(!0)}catch(s){e(s)}})}async getLookUpData(t){if(!t)return[];if(Array.isArray(t))return t.sort();if(t.trim())if(t.startsWith("$")){t=t.substring(1);let e=t.split(".");if(e.length===1){let s=await grist.docApi.fetchTable(e[0]),n=Object.keys(s||{}).filter(a=>a!=="id"&&a!=="manualSort");return n.length>0?[""].concat(s[n[0]].filter(a=>a.length>0).sort()):[]}else if(e.length>1){let s=await grist.docApi.fetchTable(e[0]);return s=s[e[1]],s?[""].concat(s.filter(n=>n.length>0).sort()):[]}else return[t]}else return[""].concat(t.split(";").filter(e=>e.length>0).sort());else return[]}grep(t,e){var s=new RegExp(e,"img");return t.match(s)}urlExists(t){if(!t)return!1;var e=new XMLHttpRequest;return e.open("HEAD",t,!1),e.send(),e.status!=404}assignDefined(t,...e){if(t)for(const s of e)for(const[n,a]of Object.entries(s))a&&(t[n]=a);return t}isObjectEmpty(t){for(let e in t)if(t.hasOwnProperty(e)&&e)return!1;return!0}async loadTranslations(t=[],e="en",s=null){if(this.translatedFiles=t,this.translatedFiles.push(this.urlSDK+"/min/widgetSDK.umd.js"),!s||typeof s=="string"){if(s=s||"i18n/"+this.culture+".json",e!==this.culture&&this.urlExists(s)){let n=await fetch(s);if(n.ok){const a=await n.text();this.I18N=JSON.parse(a)}}}else typeof s=="object"?this.I18N=s:console.error("Loading translation error");if(e!==this.culture&&this.urlExists(this.urlSDK+"/i18n/"+this.culture+".json")){let n=await fetch(this.urlSDK+"/i18n/"+this.culture+".json");if(n.ok){const a=await n.text();this.assignDefined(this.I18N,JSON.parse(a))}}return this.I18N||(this.I18N={}),this.t.bind(this)}t(t,e=null){if(Array.isArray(t))return t.map(s=>this.t(s,e));{let s=t.replaceAll(`
`,"\\n").replaceAll("  "," ");return s=this.I18N[s]||t,e&&Object.entries(e).forEach(([n,a])=>{s=s.replaceAll("%"+n,a)}),s.replaceAll("\\n",`
`)}}async extractTranslations(t,e="t"){let s={};return await Promise.all(t.map(async n=>{let a=await fetch(n);if(a.ok){a=await a.text();let l;["'",'"',"`"].forEach(r=>{l=this.grep(a,`(?<=[^a-zA-Z0-9_]${e}[(])${r}(.*?)(?<!\\\\)${r}(?=[),])`),l&&(l=l.map(o=>[o.replace(/^['"`]|['"`]$/g,""),""]),s={...s,...Object.fromEntries(l)})})}})),this._parameters&&this._parameters.forEach(n=>s={...s,...this.getOptionStrings(n)}),this.I18Ngrist&&(s={...s,...this.I18Ngrist}),s}getOptionStrings(t){let e={};return t&&(t.title&&(e[t.title]=""),t.subtitle&&(e[t.subtitle]=""),t.description&&(e[t.description]=""),t.group&&(e[t.group]=""),t.template&&(Array.isArray(t.template)?t.template.forEach(s=>e={...e,...this.getOptionStrings(s)}):e={...e,...this.getOptionStrings(t.template)})),e}saveTranslations(){}initMetaData(t=!1){return this.meta=new d,t&&(this._ismapped=!0),this.meta}async mapData(t,e,s=!1){return this.dataMapped=s,new Promise(async n=>{if(e&&(this.map=e),await this.mapOptions(),this.meta&&s&&this.col){let a=this.mapColumnNames(t),l={};Array.isArray(a)?await Promise.all(Object.entries(this.col).map(([r,o])=>new Promise(async c=>{o&&(Array.isArray(o)?await Promise.all(o.map(async h=>{await this.#r(l,a,r,h)})):await this.#r(l,a,r,o)),c(!0)}))):await Promise.all(Object.entries(this.col).map(async([r,o])=>{o&&(Array.isArray(o)?await Promise.all(o.map(async c=>{await this.#l(l,a,r,c)})):await this.#l(l,a,r,o))})),this._ismapped=!0,n(a)}this._ismapped=!0,n(this.mapColumnNames(t,e))})}async#r(t,e,s,n){const a=n.type.split(":");if((a[0]==="RefList"||a[0]==="Ref")&&n.visibleCol>0){t[a[1]]||(t[a[1]]=await grist.docApi.fetchTable(a[1]));const l=await n.getMeta(n.visibleCol);e=e.map(async r=>(r[s]=await n.parse(r[s],t[a[1]],l),r[s+"_id"]=await n.parseId(r[s],t[a[1]],l),r))}else e=e.map(async l=>(l[s]=await n.parse(l[s]),l));e=await Promise.all(e)}async#l(t,e,s,n){const a=n.type.split(":");if((a[0]==="RefList"||a[0]==="Ref")&&n.visibleCol>0){t[a[1]]||(t[a[1]]=await grist.docApi.fetchTable(a[1]));const l=await n.getMeta(n.visibleCol);e[s+"_id"]=e[s].map(async r=>await n.parseId(r,t[a[1]],l)),e[s]=e[s].map(async r=>await n.parse(r,t[a[1]],l)),e[s+"_id"]=await Promise.all(e[s+"_id"])}else e[s]=e[s].map(async l=>await n.parse(l));e[s]=await Promise.all(e[s])}async encodeData(t){return new Promise(async e=>{if(this.meta&&this.col){let s={};if(Array.isArray(t))await Promise.all(Object.entries(this.col).map(([n,a])=>new Promise(async l=>{a&&(Array.isArray(a)||(a=[a]),await Promise.all(a.map(async r=>{const o=r.type.split(":");if((o[0]==="RefList"||o[0]==="Ref")&&r.visibleCol>0){s[o[1]]||(s[o[1]]=await grist.docApi.fetchTable(o[1]));const c=await r.getMeta(r.visibleCol);t=t.map(async h=>(h.fields&&(this.is(h.fields[n])?h.fields[n]=await r.encode(h.fields[n],s[o[1]],c):this.is(h[n])&&(h[n]=await r.encode(h[n],s[o[1]],c))),h))}else t=t.map(async c=>(c.fields&&(this.is(c.fields[n])?c.fields[n]=await r.encode(c.fields[n]):this.is(c[n])&&(c[n]=await r.encode(c[n]))),c));t=await Promise.all(t)}))),l(!0)})));else{let n=t.fields??t;await Promise.all(Object.entries(this.col).map(async([a,l])=>{l&&this.is(n[a])&&(Array.isArray(l)||(l=[l]),await Promise.all(l.map(async r=>{const o=r.type.split(":");if((o[0]==="RefList"||o[0]==="Ref")&&r.visibleCol>0){s[o[1]]||(s[o[1]]=await grist.docApi.fetchTable(o[1]));const c=await r.getMeta(r.visibleCol);n[a]=await r.encode(n[a],s[o[1]],c)}else n[a]=await r.encode(n[a])})))})),t.fields&&(t.fields=n),e(t)}}e(t)})}configureOptions(t,e="#config-view",s="#main-view",n={}){if(typeof e=="string"){let a=document.querySelector(e);if(!a)throw new ReferenceError(`CSS selector "${e}" could not be found in DOM`);e=a}if(e instanceof HTMLElement)this._config=e;else throw new TypeError("Widget Config only supports usage of a string CSS selector or HTML DOM element element for the 'configID' parameter");if(typeof s=="string"){let a=document.querySelector(s);if(!a)throw new ReferenceError(`CSS selector "${s}" could not be found in DOM`);s=a}if(s instanceof HTMLElement?this._mainview=s:this._mainview=null,!t)throw new TypeError("Parameters argument for Widget Config is not defined ");Array.isArray(t)||(t=[t]),this._parameters=t,this.parseOptions(this._parameters),this.#o(),this._config.classList.contains("grist-config")||this._config.classList.add("grist-config"),this.events=n,grist.onOptions((function(a,l){this.loadOptions(a)}).bind(this)),grist.on("message",async a=>{!this._optloaded&&a.fromReady&&this.loadOptions(await grist.widgetApi.getOptions())})}static newItem(t,e,s,n=void 0,a="",l={}){return{id:t,default:e,title:s,subtitle:n,group:a,...l}}onOptChange(t){typeof t=="function"&&(this.events.onChange=t)}onOptLoad(t){typeof t=="function"&&(this.events.onLoad=t)}parseOptions(t){t.forEach(e=>{this.is(e.template)?Array.isArray(e.template)?(e.type="templateform",e.collapse=!0,e.inbloc=!0,e.default={},e.template.forEach(s=>{this.#n(s),e.default[s.id]=s.default})):(e.type="template",e.collapse=!0,e.inbloc=!0,this.#n(e.template),e.default=e.template.default):this.#n(e)})}#n(t){this.is(t.type)||(t.columnId?t.type="dropdown":typeof t.default=="boolean"?t.type="boolean":typeof t.default=="number"?t.type=this.is(t.values)?"dropdown":"number":typeof t.default=="object"?t.label&&t.event?t.type="button":t.type="object":t.type=this.is(t.values)?"dropdown":"string"),t.inbloc=t.type==="longstring"||t.type==="object"||t.type==="template"||t.type==="templateform",t.collapse=this.is(t.description)&&t.description.trim().length>0||t.inbloc}async loadOptions(t){this._optloaded=!1;try{t=t||{};const e=t.options||{};this._parameters.forEach(s=>{this.opt[s.id]=e[s.id]??(s.type==="template"||s.type==="templateform"?[]:s.default)}),this.I18N&&(this.I18Nuser=t.localization||{},this.assignDefined(this.I18N,this.I18Nuser)),this.triggerEvent("OptLoad",[this.opt])}catch(e){console.error("Error occurs on loading options:",e)}this._optloaded=!0}async mapOptions(){this._parameters&&(await this.isLoaded(),this.valuesList={},this._parameters.forEach(async t=>{let e;if(t.columnId?(e=await(await this.col[t.columnId])?.getChoices(),!e&&t.type!=="template"&&t.type!=="templateform"&&(e=await this.getLookUpData(this.opt[t.id]))):t.values&&(e=Array.isArray(t.values)?t.values:await this.getLookUpData(t.values)),this.valuesList[t.id]=e&&e.length>0?e:void 0,t.type==="template"||t.type==="templateform")if(e){const s=this.opt[t.id].length;this.opt[t.id].length=e.length,s<e.length&&this.opt[t.id].fill(t.type==="template"?t.default:{...t.default},s)}else this.opt[t.id]=[]}),await Promise.all(this._parameters))}async saveOptions(){try{this._parameters.forEach(e=>{const s=this._config.querySelector("#"+e.id);s&&(this.opt[e.id]=this.#i(e,s,this.opt[e.id]))}),await grist.widgetApi.setOption("options",this.opt);const t=this.getUserTranslations();this.isObjectEmpty(t)||(this.I18Nuser=t,this.assignDefined(this.I18N,t),await grist.widgetApi.setOption("localization",t)),this.showConfig(!1),this.triggerEvent("OptChange",[this.opt])}catch(t){console.error("Error occurs on saving options:",t)}}async readOptionValues(t,e,s){return s||(s={}),t.forEach(n=>{const a=e.querySelector("#"+n.id);a&&(s[n.id]=this.#i(n,a,s[n.id]))}),s}#o(){this.opt={},this._parameters.forEach(t=>{this.opt[t.id]=t.type==="template"||t.type==="templateform"?[]:t.default})}async resetOptions(){this.#o(),await this.mapOptions(),await grist.widgetApi.setOption("options",this.opt),await grist.widgetApi.setOption("localization",{}),this.showConfig(!1),this.triggerEvent("OptChange",[this.opt])}async showConfig(t=!0){if(t){await this.isMapped(),this._mainview&&(this._mainview.style="display: none"),this._config.style="";let e=`<div class="config-header"><button id="apply-button" class="config-button">${this.t("Apply")}</button><button id="close-button" class="config-button">${this.t("Close")}</button></div>`;e+=this.getOptionsHtml(this._parameters,this.opt,this.valuesList),this.I18N&&(e+=`<div class="config-section"><div class="config-section-title">${this.t("Localization")}</div>`,e+=`<div class="config-row"><div class="config-row-header"><div class="config-title"><div class="collapse"></div>${this.t("Extract strings")}</div>`,e+=`<div class="config-subtitle">${this.t("Click on the button to parse widget files and list all strings to translate.")}</div>`,e+=`<div class="config-value"><button id="extract-loc" class="config-button dyn">${this.t("Extract")}</button></div></div> `,e+='<div class="bloc" style="max-height: 0px;"><div id="config-loc">',e+=this.#h(),e+="</div></div></div></div>"),this._config.innerHTML=e+`<div class="config-header"><button id="reset-button" class="config-button">${this.t("Reset")}</button></div>`,this._config.querySelectorAll("div.config-switch")?.forEach(s=>{s.addEventListener("click",(function(n){this.toggleswitch(n)}).bind(this))}),this._config.querySelectorAll("div.collapse")?.forEach(s=>{s.parentElement.parentElement.addEventListener("click",(function(n){this.togglecollapse(n)}).bind(this))}),this._config.querySelectorAll("#add-button")?.forEach(s=>{s.addEventListener("click",(function(n){this.addItem(n)}).bind(this))}),this._config.querySelector("#apply-button")?.addEventListener("click",(function(){this.saveOptions()}).bind(this)),this._config.querySelector("#close-button")?.addEventListener("click",(function(){this.showConfig(!1)}).bind(this)),this._config.querySelector("#reset-button")?.addEventListener("click",(function(){this.resetOptions()}).bind(this)),this._config.querySelector("#extract-loc")?.addEventListener("click",(function(){this.extractLocStrings()}).bind(this)),this._config.querySelector("#export-loc")?.addEventListener("click",(function(){this.exportLocStrings()}).bind(this)),setTimeout(()=>{document.querySelectorAll(".auto-expand").forEach(n=>{n.style.height="",n.style.height=n.scrollHeight+"px"})},0)}else this._mainview&&(this._mainview.style=""),this._config.style="display: none"}getOptionsHtml(t,e,s={}){let n="";return Object.entries(this.#d(t,"group")).forEach(([a,l])=>{n+=`<div class="config-section"><div class="config-section-title">${this.t(a)}</div>`,l.forEach(r=>{n+=this.#e(r,e[r.id],s,-1,r.id)}),n+="</div>"}),n}setOptionsEvent(t){t.querySelectorAll("div.config-switch")?.forEach(e=>{e.addEventListener("click",(function(s){this.toggleswitch(s)}).bind(this))}),t.querySelectorAll("div.collapse")?.forEach(e=>{e.parentElement.parentElement.addEventListener("click",(function(s){this.togglecollapse(s)}).bind(this))}),t.querySelectorAll("#add-button")?.forEach(e=>{e.addEventListener("click",(function(s){this.addItem(s)}).bind(this))}),setTimeout(()=>{document.querySelectorAll(".auto-expand").forEach(s=>{s.style.height="",s.style.height=s.scrollHeight+"px"})},0)}#d=function(t,e){return t.reduce(function(s,n){return(s[n[e]]??=[]).push(n),s},{})};#e(t,e,s,n=-1,a="",l=!1){let r="";if(!t.hidden){const o=n>=0?s[t.id]?s[t.id][n]:this.t(t.title)+" #"+(n+1):this.t(t.title);r+='<div class="config-row"><div class="config-row-header"><div class="config-title',r+=`${t.collapse?'"><div class="collapse"></div>':' nocollapse">'}${o}</div>`,r+=`<div class="config-subtitle">${this.t(t.subtitle)}</div>`,r+=(t.inbloc?"":`<div class="config-value">${this.#c(t,e,s,n,a)}</div>`)+(n>=0&&!l?'<div class="delete"></div>':"")+"</div>",t.collapse&&(r+='<div class="bloc" style="max-height: 0px;">'+(this.is(t.description)?`<div class="details">${this.t(t.description).replaceAll(`
`,"<br>").replaceAll("\\n","<br>")}</div>`:""),t.type==="template"?(r+=`<div id="${t.id}" class="config-dyn">`,e?.forEach((c,h)=>{r+=this.#e(t.template,c,s,h,a+"_"+h,s[t.id])}),r+="</div>",r+=s[t.id]?"":`<div class="config-header"><button id="add-button" data-id="${t.id}" class="config-button dyn">+</button></div>`):t.type==="templateform"?(r+=`<div id="${t.id}" class="config-dyn">`,e?.forEach((c,h)=>{c&&(r+=`<div class="config-section"><div class="config-section-title">${s[t.id][h]}</div>`,Object.entries(c).forEach(([p,m])=>{r+=this.#e(t.template.find(g=>g.id===p),m,s,-1,a+"_"+h+"_"+p,s[t.id])}),r+="</div>")}),r+="</div>",r+=s[t.id]?"":`<div class="config-header"><button id="add-button" data-id="${t.id}" class="config-button dyn">+</button></div>`):t.inbloc&&(r+=this.#c(t,e,s,n,a)),r+=`${t.type!=="templateform"?'<div class="bloc-bottom">':""}</div></div>`),r+="</div>"}return r}#c(t,e,s,n=-1,a=""){const l=this.#f(t,e),r=`id="${a}" ${n>=0?`data-idx="${n}" `:""}`;switch(t.type){case"boolean":return`<div ${r}class="config-switch switch_transition ${l?"switch_on":""}" ${this.#t(t.event)}>
<div class="switch_slider"></div><div class="switch_circle"></div></div>`;case"number":return`<input ${r}type="number" class="config-input" value="${l}" ${this.#t(t.event)}>`;case"longstring":return`<textarea ${r}class="config-textarea auto-expand" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" ${this.#t(t.event)}>${l}</textarea>`;case"object":return`<textarea ${r}class="config-textarea auto-expand" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'" ${this.#t(t.event)}>${JSON.stringify(l,null,2)}</textarea>`;case"dropdown":let o=`<select ${r}class="field-select" ${this.#t(t.event)}>`;return s[t.id]&&s[t.id].forEach(c=>{o+=`<option value="${c}" ${c===l?"selected":""}>${c}</option>`}),o+"</select>";case"button":return`<button id="action-button" class="config-button" ${this.#t(t.event)}>${this.t(t.label??"Execute")}</button>`;default:return`<input ${r}class="config-input" value="${l}" ${this.#t(t.event)}>`}}#t(t){if(!t)return"";let e="";return Object.entries(t).forEach(([s,n])=>{e+=`${s}="${n}"`}),e}#i(t,e,s){switch(t.type){case"boolean":return this.#s(t,e.classList?.contains("switch_on"));case"number":return this.#s(t,parseFloat(e.value));case"object":return this.#s(t,JSON.parse(e.value));case"template":var n=[];return s.forEach((a,l)=>{let r=e.querySelector("#"+e.id+"_"+l);r?n.push(this.#i(t.template,r)):n.push(void 0)}),n;case"templateform":return s.forEach((a,l)=>{Object.keys(a).forEach(r=>{let o=e.querySelector("#"+e.id+"_"+l+"_"+r);o?a[r]=this.#i(t.template.find(c=>c.id===r),o):a[r]=void 0})}),s;default:return this.#s(t,e.value)}}#h(){let t="",e=this.I18Nuser?Object.entries(this.I18Nuser):[];return e=e.length>0?e:Object.entries(this.I18N),e.length>0?(e.sort(),e.forEach(([s,n])=>{t+=`<div class="config-row"><div class="config-row-header"><div class="config-vo">${s.replaceAll(`
`,"\\n")}</div>`,t+=`<div class="config-value large"><input class="config-input" value="${n.replaceAll(`
`,"\\n").replaceAll('"',"&quot;")}" data-key="${s.replaceAll(`
`,"\\n").replaceAll('"',"&quot;")}"></div></div></div>`}),t+=`<div class="config-header"><button id="export-loc" class="config-button dyn">${this.t("Export")}</button></div>`):t+=`<div class="details">${this.t("No string to translate, please extract them before.")}</div>`,t}getValueListOption(t,e){return this.opt[t][this.valuesList[t].indexOf(e)]}#s(t,e){return this.is(t.parse)?t.parse(e):e}#f(t,e){return this.is(t.format)?t.format(e):e}toggleswitch(t){t.currentTarget.classList.contains("switch_on")?t.currentTarget.classList.remove("switch_on"):t.currentTarget.classList.add("switch_on")}togglecollapse(t){if(t.target.getAttribute("id"))return;const e=t.currentTarget,s=e.parentElement.querySelector("div.bloc");e.classList.contains("open")?(e.classList.remove("open"),s.style="max-height: 0px;"):(e.classList.add("open"),s.style="max-height: unset;")}addItem(t){const e=t.currentTarget,s=e.parentElement.parentElement.querySelector("div.config-dyn"),n=e.getAttribute("data-id"),a=this._parameters.find(l=>l.id===n);if(a.type==="template"){const l=document.createElement("div");l.innerHTML=this.#e(a.template,a.default,this.opt[a.id].length,a.id+"_"+(this.opt[a.id].length+1)),s.appendChild(l),s.querySelector("div.collapse:last-of-type")?.parentElement.parentElement.addEventListener("click",(function(r){this.togglecollapse(r)}).bind(this)),this.opt[a.id].push(a.default)}else if(a.type==="templateform"){const l=document.createElement("div");let r=`<div class="config-section"><div class="config-section-title">${this.t(a.title)+" #"+(this.opt[a.id].length+1)}</div>`;Object.entries(a.template).forEach(([o,c])=>{r+=this.#e(c,a.default[o],-1,n+"_"+i+"_"+o)}),l.innerHTML=r+"</div>",s.appendChild(l),l.querySelectorAll("div.collapse")?.forEach(o=>{o.parentElement.parentElement.addEventListener("click",(function(c){this.togglecollapse(c)}).bind(this))}),this.opt[a.id].push(a.default)}}async extractLocStrings(){this.I18Nuser=this.assignDefined(await this.extractTranslations(this.translatedFiles),this.I18Nuser);const t=this._config.querySelector("#config-loc");t&&(t.innerHTML=this.#h(),this._config.querySelector("#export-loc")?.addEventListener("click",(function(){this.exportLocStrings()}).bind(this)))}getUserTranslations(){let t={};const e=this._config.querySelector("#config-loc");return e&&e.querySelectorAll("input.config-input")?.forEach(s=>{t[s.getAttribute("data-key")]=s.value.replaceAll("\\n",`
`).replaceAll("&quot;",'"')}),t}exportLocStrings(){const t=this.getUserTranslations();this.isObjectEmpty(t)?alert(this.t("No new translation found.")):navigator.clipboard.writeText(JSON.stringify(t,null,2)).then(()=>{alert(this.t(`Your translation has been copied to the clipboard, share it with the widget creator throw the Grist forum or his Github.
Thanks a lot for your time !`))})}ready(t){t&&(t.columns&&(this.I18Ngrist={},t.columns.map(e=>(e.title&&(this.I18Ngrist[e.title]="",e.title=this.t(e.title)),e.description&&(this.I18Ngrist[e.description]="",e.description=this.t(e.description)),e))),t.onEditOptions&&(this.onEditOptionsUser=t.onEditOptions),t.onEditOptions=this.onEditOptions.bind(this)),grist.ready(t)}async onEditOptions(){await this.showConfig(),this.onEditOptionsUser&&await this.onEditOptionsUser.apply()}formatRecord(t,e){return{id:parseInt(t),fields:e}}#a(){return this.table||(this.table=grist.getTable()),!!this.table}async updateRecords(t,e){return e=e??this.dataMapped,this.#a()?(e&&(t=await this.encodeData(t)),t=Array.isArray(t)?t.map(s=>this.mapColumnNamesBack(s)):this.mapColumnNamesBack(t),this.applyModificationOnGrist(async()=>this.table.update(t))):null}async createRecords(t,e){return e=e??this.dataMapped,this.#a()?(e&&(t=await this.encodeData(t)),t=Array.isArray(t)?t.map(s=>this.mapColumnNamesBack(s)):this.mapColumnNamesBack(t),this.applyModificationOnGrist(async()=>this.table.create(t))):null}async destroyRecords(t){return this.#a()?this.applyModificationOnGrist(async()=>Array.isArray(t)?await this.table.destroy(t.map(e=>parseInt(e))):await this.table.destroy(t)):null}async applyModificationOnGrist(t){if(!t)return null;this.dataMapped&&(this._ismapped=!1);const e=await t();return this.dataMapped&&await this.isMapped(),e}mapColumnNamesBack(t){return t.fields=Object.fromEntries(Object.entries(t.fields).map(e=>[this.map[e[0]]??e[0],e[1]])),t}mapColumnNames(t,e=null){return e||(e=this.map),e?Array.isArray(t)?t.map(s=>this.mapColumnNames(s,e)):(e=Object.fromEntries(Object.entries(e).map(s=>s[1]?[s[1],s[0]]:[s[0],s[1]])),Object.fromEntries(Object.entries(t).map(s=>[e[s[0]]??s[0],s[1]]))):t}onRecords(t,e){grist.onRecords(async(s,n)=>{this._ismapped=!1,await this.isInit(),t(await this.mapData(s,n,e.mapRef))},e)}onRecord(t,e){grist.onRecord(async(s,n)=>{this._ismapped=!1,await this.isInit(),t(await this.mapData(s,n,e.mapRef))},e)}onMappingChange(t){grist.on("message",async e=>{e.mappingsChange&&t()})}async fetchSelectedRecord(t){let e=await grist.fetchSelectedRecord(t);const s=this.mapColumnNames(e);return this.dataMapped&&await this.isMapped(),s}}return u});
