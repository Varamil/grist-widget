(function(a){typeof define=="function"&&define.amd?define(a):a()})(function(){"use strict";let a,d;const E=new Date("3000-01-01"),m="#DCDCDC",g="#000000";let A,h=[];window.addEventListener("load",async e=>{a=new WidgetSDK,d=await a.loadTranslations(["widget.js"]);const t=`If empty, the widget use the column properties (based on choices or references) to make the list. Else, you can either:
• Provides a list, separated by ";"
• Provides a reference to a table or a column starting with a "$" ($TableID or $TableID.ColumnID)`;a.configureOptions([WidgetSDK.newItem("columns",null,"Behavior","Configure the behavior of each columns","Columns",{columnId:"STATUT",template:[WidgetSDK.newItem("addbutton",!0,"Can add card","If checked, display a button to add card to the column."),WidgetSDK.newItem("isdone",!1,"Is done","If checked, cards in the columns are considered as over."),WidgetSDK.newItem("useconfetti",!1,"Use confetti","If checked, confetti apprear when a card enter in the column.")]}),WidgetSDK.newItem("ref","","References","List of task references available.","Cards options",{description:t,columnId:"REFERENCE_PROJET",type:"lookup"}),WidgetSDK.newItem("types","","Type","List of task types available.","Cards options",{description:t,columnId:"TYPE",type:"lookup"}),WidgetSDK.newItem("incharge","","In charge","List of people that can be in charge of the task.","Cards options",{description:t,columnId:"RESPONSABLE",type:"lookup"}),WidgetSDK.newItem("rotation",!0,"Tilt","If checked, cards are randomly tilted.","Display"),WidgetSDK.newItem("compact",!1,"Compact","If checked, use a compact rendering.","Display"),WidgetSDK.newItem("readonly",!1,"Read only","If checked, kanban is ready only.","Display")],"#config-view","#main-view",{onOptChange:C,onOptLoad:C}),a.initMetaData(),a.ready({requiredAccess:"full",columns:[{name:"STATUT",title:"Status",description:"Defines the Kanban column",type:"Choice",strictType:!0},{name:"DESCRIPTION",title:"Task",description:"Main card content",type:"Any"},{name:"DEADLINE",title:"Deadline",description:"Can also be use as priority",type:"Date"},{name:"REFERENCE_PROJET",title:"Reference",description:"Reference associated with the task",type:"Any",optional:!0},{name:"TYPE",title:"Type",description:"Type associated with the task",type:"Any",optional:!0},{name:"RESPONSABLE",title:"In charge",description:"Who is in charge",type:"Any",optional:!0},{name:"CREE_PAR",title:"Created by",type:"Any",optional:!0},{name:"CREE_LE",title:"Creation date",type:"DateTime",optional:!0},{name:"DERNIERE_MISE_A_JOUR",title:"Last update date",description:"Updated after any change",type:"DateTime",optional:!0},{name:"NOTES",title:"Notes",description:"Additional notes",type:"Any",optional:!0},{name:"COULEUR",title:"Card color",description:"Choice or html value",type:"Choice,Text",optional:!0},{name:"TAGS",title:"Tags",description:"Additional fields to display",type:"Any",optional:!0,allowMultiple:!0}]}),a.onRecords(v,{expandRefs:!1,keepEncoded:!1,mapRef:!0}),a.isLoaded().then(async()=>{a.initDone=!0}),grist.on("message",async n=>{n.mappingsChange&&$()})});async function v(e){A=e;const t=document.getElementById("conteneur-kanban");t.innerHTML="";const n=await a.col.STATUT.getChoices();if(!n||n.length===0){console.error(d("No choice available in the Status column"));return}n.forEach((i,o)=>{t.appendChild(R(i,o))}),e?.length>0&&(e.forEach(i=>{const o=D(i),s=document.querySelector(`.contenu-colonne[data-statut="${i.STATUT}"]`);s&&s.insertBefore(o,s.firstChild)}),a.opt.readonly||document.querySelectorAll(".contenu-colonne").forEach(i=>{new Sortable(i,{group:"kanban-todo",animation:150,onEnd:async function(o){const s=o.to.dataset.statut;if(s===o.from.dataset.statut){let c=o.item.dataset.deadline||"9999-12-31";if(o.oldIndex!==o.newIndex&&new Date(c)>=E){let u=E.getFullYear(),l=[];document.querySelectorAll(".contenu-colonne").forEach(r=>{r.getAttribute("data-statut")===s&&r.querySelectorAll(".carte").forEach(async p=>{c=p.getAttribute("data-deadline")||"9999-12-31",new Date(c)>=E&&(c=`${u}-01-01`,p.setAttribute("data-deadline",c),u+=1,l.push(a.formatRecord(p.getAttribute("data-todo-id"),{DEADLINE:c})))})});try{await a.updateRecords(l)}catch(r){console.error(d("Error during status update:"),r)}}}else try{await L(o.item.dataset.todoId,"STATUT",s)}catch(c){console.error(d("Error during status update:"),c)}S(i)}}),S(i)}),document.querySelectorAll(".colonne-kanban").forEach(w))}async function C(e){await a.isMapped(),v(A)}function R(e,t){const n=a.opt.columns[t],i=document.createElement("div");return i.className=`colonne-kanban ${n.addbutton?"":"colonne-nobouton"}`,i.id=e,localStorage.getItem(`column-todo-${e}`)==="true"&&i.classList.add("collapsed"),i.innerHTML=`
        <div class="entete-colonne" style="background-color: ${a.col.STATUT.getColor(e)??m};color:${a.col.STATUT.getTextColor(e)??g}">
            <div class="titre-statut">${e} <span class="compteur-colonne">(0)</span></div>
            ${n.addbutton&&!a.opt.readonly?`
            <button class="bouton-ajouter-entete ${a.opt.compact?" compact":""}" onclick="creerNouvelleTache('${e}')">+</button>
            `:""}
            <button class="bouton-toggle" onclick="toggleColonne(this.closest('.colonne-kanban'), event)">⇄</button>
        </div>
        ${n.addbutton&&!a.opt.readonly?`
            <button class="bouton-ajouter ${a.opt.compact?" compact":""}" onclick="creerNouvelleTache('${e}')">+ ${d("Add a new task")}</button>
        `:""}
        <div class="contenu-colonne" data-statut="${e}"></div>
    `,i}function $(){const e=document.getElementsByClassName("colonne-kanban");Array.prototype.forEach.call(e,t=>{t.style=`background-color: ${a.col.STATUT.getColor(t.id)??m};color:${a.col.STATUT.getTextColor(t.id)??g}`}),I()}async function I(){await a.isMapped(),h=[],a.map.TAGS&&(h=await a.map.TAGS.map(async e=>await(await a.meta.getColMeta(e))?.getChoices()??[]),h=await Promise.all(h))}function D(e){const t=document.createElement("div");t.className=`carte ${a.opt.rotation?"":" norotate"}${a.opt.compact?" compact":""}`,t.setAttribute("data-todo-id",e.id),t.setAttribute("data-last-update",e.DERNIERE_MISE_A_JOUR||""),t.setAttribute("data-deadline",e.DEADLINE||""),e.COULEUR&&a.col.COULEUR.type==="Choice"&&(a.col.COULEUR.getColor(e.COULEUR)?t.setAttribute("style",`background-color: ${(e.COULEUR.startsWith("#")?"":"#")+e.COULEUR}`):t.setAttribute("style",`background-color: ${(e.COULEUR.startsWith("#")?"":"#")+e.COULEUR}`));const n=e.TYPE||"",i=e.DESCRIPTION||d("No description"),o=e.DEADLINE?b(e.DEADLINE):"",s=e.RESPONSABLE||"",c=e.REFERENCE_PROJET,u=e.TAGS||[];let l="";u.forEach(p=>l+=p?`<div class="more-tag">${p}</div>`:"");const r=a.getValueListOption("columns",e.STATUT);return t.innerHTML=`
        ${c&&c.length>0?`<div class="projet-ref truncate">#${c}</div>`:""}
        ${n?`<div class="type-tag truncate">${n}</div>`:c&&c.length>0?"<div>&nbsp;</div>":""}
        ${u.length>0?`<div>${l}</div>`:""}
        <div class="description">${i}</div>
        ${o?`<div class="deadline${e.DEADLINE<Date.now()?" late":""} truncate">📅 ${o}</div>`:s?"<div>&nbsp;</div>":""}
        ${s?`<div class="responsable-badge truncate">${s}</div>`:""}
        ${r?.isdone?`<div class="tampon-termine" style="color: ${a.col.STATUT.getColor(e.STATUT)??m};">${e.STATUT}</div>`:""}      
    `,t.addEventListener("click",()=>O(e)),t}async function L(e,t,n,i){try{if(i?.stopPropagation(),t==="STATUT"){const s=a.getValueListOption("columns",n);s&&s.useconfetti&&U()}let o={[t]:n||void 0};a.map.DERNIERE_MISE_A_JOUR&&(o.DERNIERE_MISE_A_JOUR=new Date().toISOString()),await a.updateRecords(a.formatRecord(e,o))}catch(o){console.error(d("Error during update:"),o)}}function S(e){const t=Array.from(e.children),n=e.dataset.isdone;t.sort((i,o)=>{if(n){const s=i.getAttribute("data-last-update")||"1970-01-01",c=o.getAttribute("data-last-update")||"1970-01-01",u=new Date(c)-new Date(s);if(u===0){const l=parseInt(i.getAttribute("data-todo-id"))||0;return(parseInt(o.getAttribute("data-todo-id"))||0)-l}else return u}else{const s=i.getAttribute("data-deadline")||"9999-12-31",c=o.getAttribute("data-deadline")||"9999-12-31",u=new Date(s)-new Date(c);if(u===0){const l=parseInt(i.getAttribute("data-todo-id"))||0;return(parseInt(o.getAttribute("data-todo-id"))||0)-l}else return u}}),t.forEach(i=>e.appendChild(i))}function w(e){const t=e.querySelector(".contenu-colonne"),n=e.querySelector(".compteur-colonne");t&&n&&(n.textContent=`(${t.children.length})`)}function O(e){const t=document.getElementById("popup-todo"),n=document.querySelector(".carte.active"),i=document.querySelector(`[data-todo-id="${e.id}"]`),o=a.getValueListOption("columns",e.STATUT);if(a.opt.readonly){y();return}n?.classList.remove("active"),i?.classList.add("active"),t.style=`border-left-color: ${a.col.STATUT.getColor(e.STATUT)??m}`,t.dataset.statut=e.STATUT,t.dataset.isdone=o?!1:o.isdone,t.dataset.currentTodo=e.id;const s=t.querySelector(".popup-title"),c=t.querySelector(".popup-content"),u=t.querySelector(".popup-header");u.style=`background-color: ${a.col.STATUT.getColor(e.STATUT)??m};color:${a.col.STATUT.getTextColor(e.STATUT)??g}`,s.textContent=e.DESCRIPTION||"Nouvelle tâche";let l=1,r='<div class="field-row">';r+=`
        <div class="field">
          <label class="field-label">Date limite</label>
          <input type="date" class="field-input" 
                 value="${N(e.DEADLINE)}"
                 onchange="mettreAJourChamp(${e.id}, 'DEADLINE', this.value, event)">
        </div>
    `,a.map.REFERENCE_PROJET&&(r+=T(e.id,e.REFERENCE_PROJET,a.valuesList.ref,d("Reference"),"REFERENCE_PROJET"),l+=1),l%2===0&&(r+='</div><div class="field-row">'),a.map.TYPE&&(r+=T(e.id,e.TYPE,a.valuesList.types,d("Type"),"TYPE"),l+=1),l%2===0&&(r+='</div><div class="field-row">'),a.map.RESPONSABLE&&(r+=T(e.id,e.RESPONSABLE,a.valuesList.incharge,d("In charge"),"RESPONSABLE"),l+=1),l%2===0&&(r+='</div><div class="field-row">'),a.map.TAGS&&a.map.TAGS.forEach((p,f)=>{r+=T(e.id,e.TAGS[f],h[f],p,p),l+=1,l%2===0&&(r+='</div><div class="field-row">')}),r+=`</div>
        <div class="field">
            <label class="field-label">${d("Description")}</label>
            <textarea class="field-textarea auto-expand" 
                    onchange="mettreAJourChamp(${e.id}, 'DESCRIPTION', this.value, event)"
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${e.DESCRIPTION||""}</textarea>
        </div>
    `,a.map.NOTES&&(r+=`<div class="field">
            <label class="field-label">${d("Notes")}</label>
            <textarea class="field-textarea auto-expand" 
                      onchange="mettreAJourChamp(${e.id}, 'NOTES', this.value, event)"
                      oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${e.NOTES||""}</textarea>
          </div>
        `),(a.map.CREE_LE&&e.CREE_LE||a.map.CREE_PAR&&e.CREE_PAR)&&(r+=`<div class="info-creation">
                ${d("Created")} ${a.map.CREE_LE&&e.CREE_LE?d("on %on",{on:b(e.CREE_LE)}):""} ${a.map.CREE_PAR&&e.CREE_PAR?d("by %by",{on:e.CREE_PAR||"-"}):""}
            </div>
        `),a.opt.readonly||(r+=` 
          <div class="popup-actions">
            <button class="popup-action-button bouton-supprimer" onclick="supprimerTodo(${e.id}, event)" 
                    title="${d("Remove the task")}">🗑️</button>
          </div>
        `),c.innerHTML=r,setTimeout(()=>{document.querySelectorAll(".auto-expand").forEach(f=>{f.style.height="",f.style.height=f.scrollHeight+"px"})},0),t.classList.add("visible")}function T(e,t,n,i,o){let s="";return n?.length>0?n.length<10?(s+=`
                <div class="field">
                    <label class="field-label">${i}</label>
                    <select class="field-select" onchange="mettreAJourChamp(${e}, '${o}', this.value, event)">
                    <option value=""></option>`,n.forEach(c=>{s+=`<option value="${c}" ${t===c?"selected":""}>${c}</option>`}),s+=`</select>
                </div>        
            `):(s+=`
                <div class="field">
                    <label class="field-label">${i}</label>
                    <input type="text" list="list-${o}" class="field-select" onchange="mettreAJourChamp(${e}, '${o}', this.value, event)" />
                    <datalist id="list-${o}">`,n.forEach(c=>{s+=`<option value="${c}" ${t===c?"selected":""}>${c}</option>`}),s+=`</datalist>
                </div>        
            `):s+=`
            <div class="field">
                <label class="field-label">${i}</label>
                <input type="text" class="field-input" value="${t||""}" 
                    onchange="mettreAJourChamp(${e}, '${o}', this.value, event)">
            </div>
        `,s}function y(){const e=document.getElementById("popup-todo"),t=e.dataset.currentTodo,n=document.querySelector(`[data-todo-id="${t}"]`);n&&n.classList.remove("active"),e.classList.remove("visible")}document.addEventListener("keydown",e=>{e.key==="Escape"&&y()}),document.addEventListener("click",e=>{const t=document.getElementById("popup-todo");t.classList.contains("visible")&&!t.querySelector(".popup-content").contains(e.target)&&!e.target.closest(".carte")&&!e.target.closest(".popup-header")&&y()});function U(){const t=Date.now()+2e3,n={startVelocity:30,spread:360,ticks:60,zIndex:0};function i(s,c){return Math.random()*(c-s)+s}const o=setInterval(function(){const s=t-Date.now();if(s<=0)return clearInterval(o);const c=50*(s/2e3);confetti(Object.assign({},n,{particleCount:c,origin:{x:i(.1,.3),y:Math.random()-.2}})),confetti(Object.assign({},n,{particleCount:c,origin:{x:i(.7,.9),y:Math.random()-.2}}))},250)}function b(e){if(!e)return"-";const t=new Date(e);if(t>=E)return null;const n=t.getDate().toString().padStart(2,"0"),i=t.toLocaleDateString(a.cultureFull,{month:"short"}),o=t.getFullYear();return`${n} ${i} ${o}`}function N(e){if(!e)return"";try{const t=new Date(e);return t>=E?"":t.toISOString().split("T")[0]}catch(t){return console.error(d("Error on date formating:"),t),""}}});
